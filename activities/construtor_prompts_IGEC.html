<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Construtor de prompts para IGEC</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #007A3D;   /* IGEC green darkened for AA contrast on white (5.1:1) */
            --primary-brand: #00A651; /* IGEC brand green ‚Äî use only on dark/coloured backgrounds */
            --accent: #005C2E;    /* Darker green for hover states on white (7.1:1) */
            --bg: #f8f9fa;
            --surface: #ffffff;
            --border: #b8d9b8;    /* Green-tinted border, visible against white */
            --radius: 12px;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --text-main: #0a0e27;
            --text-secondary: #3e4854;
            --focus-ring: 0 0 0 3px #fff, 0 0 0 5px #007A3D;
            --error: #c41e3a;
            --success: #007A3D;   /* AA-compliant green for success text on white */
            --saving: #b45309;    /* Amber darkened for AA on white (4.6:1) */
        }

        .skip-link {
            position: absolute; top: -100px; left: 1rem; z-index: 99999;
            background: var(--primary); color: #fff; padding: 10px 18px;
            border-radius: 0 0 8px 8px; font-weight: 700; text-decoration: none;
            font-size: 0.9rem; transition: top 0.2s;
        }
        .skip-link:focus { top: 0; }

        body, html {
            height: 100%; margin: 0;
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
        }

        .app-wrapper {
            display: flex; flex-direction: column; height: 100vh;
        }

        header {
            background: var(--accent); color: white; /* #005C2E on white text: 7.1:1 ‚Äî AAA */
            padding: 1rem 2.5rem; display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow);
        }

        .main-content {
            display: flex; flex: 1; overflow: hidden; padding: 25px; gap: 25px;
            background: white;
        }

        .editor-panel, .preview-panel {
            flex: 1; display: flex; flex-direction: column;
            background: var(--surface);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .panel-scroll {
            flex: 1; overflow-y: auto; padding: 25px;
            background: white;
        }

        .panel-header {
            background: #fafafa;
            padding: 15px 25px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            font-weight: 700; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px;
            color: var(--primary);
        }

        .field-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
        }

        label {
            font-weight: 700;
            color: var(--primary);
            font-size: 0.9rem;
            display: block;
            margin-bottom: 4px;
            text-transform: none;
        }

        .hint {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: block;
            line-height: 1.5;
        }

        select, input[type="text"], input[type="email"], input[type="password"] {
            min-height: 44px;
            font-size: 1rem;
        }

        .input-container { position: relative; margin-bottom: 28px; }

        textarea {
            width: 100%;
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 14px 14px 42px 14px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 90px;
            box-sizing: border-box;
            transition: all 0.2s;
            background-color: #fff;
            color: var(--text-main);
            line-height: 1.5;
        }

        textarea:focus {
            outline: none;
            border: 2px solid var(--primary);
            box-shadow: 0 0 0 3px rgba(0, 122, 61, 0.18);
        }

        :focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
            border-radius: 4px;
        }
        button:focus-visible, a:focus-visible {
            box-shadow: var(--focus-ring);
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }
        input:focus-visible, select:focus-visible, textarea:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }

        .lazy-prompt { background-color: #fdfdfd; border: 1px dashed var(--border); }

        .fullscreen-btn {
            position: absolute; bottom: 10px; right: 10px; z-index: 10;
            background: #eceff1; border: none; cursor: pointer; color: var(--primary);
            padding: 5px 10px; border-radius: 6px; display: flex; align-items: center; gap: 5px;
            font-size: 0.75rem; font-weight: 600; font-family: inherit;
            transition: 0.2s; letter-spacing: 0.3px;
            opacity: 0.55;
        }
        .input-container:hover .fullscreen-btn,
        .fullscreen-btn:focus-visible { opacity: 1; }
        .fullscreen-btn:hover { background: #cfd8dc; transform: translateY(-1px); opacity: 1; }

        .hide-toggle-btn {
            background: none;
            border: 2px solid transparent;
            cursor: pointer;
            padding: 6px 8px;
            border-radius: 4px;
            color: var(--text-secondary);
            line-height: 1;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            font-family: inherit;
            font-weight: 600;
            transition: color 0.15s, background 0.15s, border 0.15s;
            opacity: 0.7;
            min-width: 44px;
            min-height: 44px;
        }
        .hide-toggle-btn:hover {
            opacity: 1;
            color: var(--primary);
            background: #f0f2f5;
        }
        .hide-toggle-btn:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        .hide-toggle-btn[aria-pressed="true"] {
            color: var(--error);
            opacity: 1;
            background: #fde8e8;
        }
        .hide-toggle-btn[aria-pressed="true"]:hover {
            color: #8b0000;
            background: #f5c1c1;
        }
        .hide-toggle-btn .icon-eye-open  { display: inline-block; }
        .hide-toggle-btn .icon-eye-slash { display: none; }
        .hide-toggle-btn[aria-pressed="true"] .icon-eye-open  { display: none; }
        .hide-toggle-btn[aria-pressed="true"] .icon-eye-slash { display: inline-block; }

        .input-container.field-hidden textarea {
            opacity: 0.6;
            border-style: dashed;
            border-color: var(--border);
            background-color: #f8f9fa;
            color: var(--text-secondary);
        }
        .input-container.field-hidden > .field-header > label {
            text-decoration: line-through;
            color: var(--text-secondary);
        }
        .input-container.field-hidden::after {
            content: " (ocultado do prompt)";
            font-size: 0.75rem;
            color: var(--text-secondary);
            font-style: italic;
        }

        .field-header label { margin-bottom: 0; }

        textarea.fullscreen-active {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 9999; border-radius: 0; padding: 50px; font-size: 1.25rem;
            background: white; line-height: 1.6;
        }

        .fs-exit-btn {
            position: fixed; top: 18px; right: 24px; z-index: 10000;
            background: var(--primary); color: white; border: none; cursor: pointer;
            padding: 10px 18px; border-radius: 8px; font-size: 0.9rem; font-weight: 700;
            font-family: inherit; display: flex; align-items: center; gap: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2); transition: 0.2s;
        }
        .fs-exit-btn:hover { background: var(--accent); transform: translateY(-1px); }

        .preview-body {
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            line-height: 1.6;
            white-space: pre-wrap;
            color: var(--text-main);
            background: #ffffff;
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 20px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .tag-h1 { color: #e65100; font-weight: bold; border-bottom: 2px solid #ffccbc; padding-bottom: 2px; }

        .actions { display: flex; gap: 12px; padding: 20px 25px; background: #fafafa; border-top: 1px solid var(--border); }

        .btn {
            flex: 1;
            padding: 14px;
            border-radius: 8px;
            border: 2px solid transparent;
            font-weight: 700;
            cursor: pointer;
            transition: 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            text-decoration: none;
        }

        .btn-copy {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        .btn-copy:hover { background: var(--accent); border-color: var(--accent); }
        .btn-copy:active { transform: translateY(1px); }

        .btn-download {
            background: #3e4854;
            color: white;
            border-color: #3e4854;
        }
        .btn-download:hover { background: var(--accent); border-color: var(--accent); }
        .btn-download:active { transform: translateY(1px); }

        .btn-reset {
            background: transparent;
            color: var(--text-secondary);
            border: 2px solid var(--border);
            flex: 0.4;
        }
        .btn-reset:hover { border-color: var(--primary); color: var(--primary); background: #f0f2f5; }
        .btn-reset:active { transform: translateY(1px); }

        /* Buttons inside the dark header ‚Äî white text on dark green */
        .btn-header {
            background: rgba(255,255,255,0.15);
            color: #ffffff;
            border: 2px solid rgba(255,255,255,0.5);
            flex: none;
            font-size: 0.8rem;
            padding: 8px 14px;
        }
        .btn-header:hover { background: rgba(255,255,255,0.28); border-color: #ffffff; }
        .btn-header:active { transform: translateY(1px); }
        .btn-header--danger { border-color: rgba(255,180,160,0.7); color: #ffe0d6; }
        .btn-header--danger:hover { background: rgba(220,60,30,0.25); border-color: #ffb4a0; }

        .btn:focus-visible {
            outline: 3px solid var(--primary);
            outline-offset: 2px;
        }

        #save-status {
            font-weight: 400;
            text-transform: none;
            color: var(--success);
            font-size: 0.75rem;
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
        }

        hr { border: 0; border-top: 1px solid #eceff1; margin: 35px 0; }

        .prompt-stats {
            text-align: right; font-size: 0.78rem; color: var(--text-secondary);
            margin-top: 10px; font-family: 'Fira Code', monospace;
        }

        .btn-schema {
            background: transparent; color: var(--text-secondary); border: 1px solid var(--border);
            border-radius: 6px; padding: 4px 10px; font-size: 0.75rem; font-weight: 600;
            font-family: inherit; cursor: pointer; transition: 0.2s; white-space: nowrap; text-transform: none;
        }
        .btn-schema:hover { background: #eceff1; color: var(--primary); border-color: #90a4ae; }

        .example-toggle-btn {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 2px dashed var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.85rem;
            font-family: inherit;
            font-weight: 600;
            transition: 0.2s;
            text-align: center;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .example-toggle-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #f8f9fa;
        }
        .example-toggle-btn:focus-visible {
            outline: 2px solid var(--primary);
            outline-offset: 2px;
        }
        .example-toggle-btn.active {
            border-color: var(--error);
            color: var(--error);
            background: #fde8e8;
        }
        .example-toggle-btn.active:hover {
            border-color: #8b0000;
            color: #8b0000;
            background: #f5c1c1;
        }

        @media (max-width: 900px) {
            .main-content { flex-direction: column; overflow-y: auto; }
            .editor-panel, .preview-panel { min-height: 600px; }
        }

        @media (prefers-reduced-motion: reduce) {
            * { animation: none !important; transition: none !important; }
        }

        @media (prefers-color-scheme: dark) {
            body, html {
                background-color: #ffffff;
                color: var(--text-main);
            }
            .editor-panel, .preview-panel { background: #ffffff; }
            .panel-header { background: #f5f5f5; }
            .preview-body { background: #ffffff; color: var(--text-main); }
            textarea { background-color: #ffffff; color: var(--text-main); border-color: var(--border); }
            select { background-color: #ffffff; color: var(--text-main); }
        }
    
  .checkbox-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    gap: 12px 14px;
  }
  .checkbox-grid label {
    font-weight: 500;
    color: var(--text-main);
    display: flex;
    align-items: center;
    cursor: pointer;
    margin: 0;
  }
  .checkbox-grid input {
    margin-right: 8px;
    cursor: pointer;
    width: 18px;
    height: 18px;
    min-width: 18px;
    accent-color: var(--primary);
  }
  .checkbox-grid input:focus-visible {
    outline: 2px solid var(--primary);
    outline-offset: 2px;
  }
</style>
</head>
<body>

<a class="skip-link" href="#main-content">Ir para o conte√∫do principal</a>

<div class="app-wrapper">
    <header role="banner">
        <div>
            <h1 style="margin:0; font-size: 1.5rem; letter-spacing: -0.5px;">Construtor de prompts para IGEC <span style="font-size: 0.75rem; font-weight: 400; opacity: 0.6; letter-spacing: 0;">v1.0</span></h1>
            <span style="font-size: 0.85rem; opacity: 0.9;">Estruture o seu pensamento. Molde o resultado.</span>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="btn btn-header" onclick="backupCacheJSON()" title="Guardar uma c√≥pia de seguran√ßa do seu trabalho atual (JSON)">üíæ Backup JSON</button>
            <button class="btn btn-header" onclick="restoreCacheJSON()" title="Restaurar uma c√≥pia de seguran√ßa anterior (JSON)">üìÇ Restaurar JSON</button>
            <button class="btn btn-header" onclick="backupCacheMD()" title="Guardar uma c√≥pia de seguran√ßa do seu trabalho atual (Markdown)">üìù Backup MD</button>
            <button class="btn btn-header" onclick="restoreCacheMD()" title="Restaurar uma c√≥pia de seguran√ßa anterior (Markdown)">üì• Importar MD</button>
            <button class="btn btn-header btn-header--danger" onclick="resetForm()">Limpar Dados</button>
        </div>
    </header>

    <div id="a11y-announce" aria-live="polite" aria-atomic="true" style="position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;"></div>

    <main id="main-content" class="main-content">
        <section class="editor-panel" aria-label="Construtor de prompt">
            <div class="panel-header">
                <span aria-hidden="true">Construtor de Prompt</span>
                <button class="btn-schema" onclick="exportSchema()" aria-label="Exportar esquema da interface como ficheiro Markdown">Exportar esquema</button>
            </div>
            <div class="panel-scroll">
                <div class="input-container">
                    <label for="draft">Pedido Inicial (para refer√™ncia)</label>
                    <span id="hint-draft" class="hint">A sua ideia em bruto. Exemplo: "Elaborar um relat√≥rio sobre seguran√ßa escolar."</span>
                    <textarea id="draft" class="lazy-prompt" placeholder="Escreva ou cole a sua ideia inicial aqui..."
                        aria-describedby="hint-draft"></textarea>
                </div>

                <hr aria-hidden="true">

                <div class="input-container" id="container-persona">
                    <div class="field-header">
                        <label for="persona"># PERSONA/PAPEL</label>
                        <button class="hide-toggle-btn" id="hide-btn-persona" aria-pressed="false"
                            aria-label="Ocultar Persona/Papel do prompt"
                            onclick="toggleHide('persona', 'Persona/Papel')">
                            <svg class="icon-eye-open" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg class="icon-eye-slash" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                        </button>
                    </div>
                    <span id="hint-persona" class="hint"></span>
                    <label for="persona_role" style="font-weight: 700; color: var(--primary); font-size: 0.9rem; display: block; margin-bottom: 8px;">Cargo/Fun√ß√£o:</label>
                    <select id="persona_role" style="width: 100%; border: 2px solid var(--border); border-radius: 8px; padding: 10px 12px; font-size: 1rem; font-family: inherit; margin-bottom: 20px; background-color: #fff; transition: all 0.2s; min-height: 44px;" aria-label="Selecionar cargo ou fun√ß√£o">
                        <option value="">Selecione um cargo...</option>
                        <option value="Subinspetor-geral/inspetor-geral">Subinspetor-geral/inspetor-geral</option>
                        <option value="Chefe de equipa">Chefe de equipa</option>
                        <option value="Inspetor">Inspetor</option>
                        <option value="Averiguante">Averiguante</option>
                        <option value="Relator">Relator</option>
                        <option value="Avaliador">Avaliador</option>
                        <option value="Interlocutor">Interlocutor</option>
                        <option value="Formador">Formador</option>
                        <option value="Instrutor">Instrutor</option>
                        <option value="Coordenador">Coordenador</option>
                        <option value="T√©cnico Superior">T√©cnico Superior</option>
                        <option value="Diretor de servi√ßos">Diretor de servi√ßos</option>
                    </select>
                    <textarea id="persona" placeholder="Age como um..."
                        aria-describedby="hint-persona"></textarea>
                    <button class="fullscreen-btn" onclick="toggleFS('persona')" aria-label="Expandir Persona/Papel para ecr√£ inteiro">‚õ∂ Ecr√£ Inteiro</button>
                </div>

                <div class="input-container" id="container-context">
                    <div class="field-header">
                        <label for="context"># CONTEXTO</label>
                        <button class="hide-toggle-btn" id="hide-btn-context" aria-pressed="false"
                            aria-label="Ocultar Contexto do prompt"
                            onclick="toggleHide('context', 'Contexto')">
                            <svg class="icon-eye-open" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg class="icon-eye-slash" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                        </button>
                    </div>
                    <span id="hint-context" class="hint">Informa√ß√µes de fundo (ex.: Decreto-Lei 54/2018, reclama√ß√µes espec√≠ficas).</span>
                    <div style="margin-bottom: 14px;">
                        <label style="display:flex; align-items:center; gap:10px; font-weight:500; color:var(--text-main); cursor:pointer;">
                            <input type="checkbox" id="context_addendum_toggle"
                                   style="width:18px; height:18px; min-width:18px; accent-color:var(--primary); cursor:pointer;"
                                   aria-describedby="hint-context">
                            Incluir enquadramento legal e org√¢nico da IGEC no prompt
                        </label>
                    </div>
                    <textarea id="context" placeholder="Esta tarefa decorre de..."
                        aria-describedby="hint-context"></textarea>
                    <button class="fullscreen-btn" onclick="toggleFS('context')" aria-label="Expandir Contexto para ecr√£ inteiro">‚õ∂ Ecr√£ Inteiro</button>
                </div>

                <div class="input-container" id="container-objective">
                    <div class="field-header">
                        <label for="objective"># OBJETIVO</label>
                        <button class="hide-toggle-btn" id="hide-btn-objective" aria-pressed="false"
                            aria-label="Ocultar Objetivo do prompt"
                            onclick="toggleHide('objective', 'Objetivo')">
                            <svg class="icon-eye-open" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg class="icon-eye-slash" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                        </button>
                    </div>
                    <span id="hint-objective" class="hint">A√ß√£o ou resultado exato pretendido.</span>
                    <textarea id="objective" placeholder="O objetivo principal √©..."
                        aria-describedby="hint-objective"></textarea>
                    <button class="fullscreen-btn" onclick="toggleFS('objective')" aria-label="Expandir Objetivo para ecr√£ inteiro">‚õ∂ Ecr√£ Inteiro</button>
                </div>

                <div class="input-container" id="container-audience">
                    <div class="field-header">
                        <label for="audience"># AUDI√äNCIA</label>
                        <button class="hide-toggle-btn" id="hide-btn-audience" aria-pressed="false"
                            aria-label="Ocultar Audi√™ncia do prompt"
                            onclick="toggleHide('audience', 'Audi√™ncia')">
                            <svg class="icon-eye-open" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg class="icon-eye-slash" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                        </button>
                    </div>
                    <span id="hint-audience" class="hint">Quem vai ler o resultado?</span>
                    
      <fieldset id="audience_checks" aria-label="Selecionar audi√™ncia (m√∫ltipla)" style="border:0;padding:0;margin:0 10px 12px 0;">
        <legend class="hint" style="margin:0 0 8px 0;">Selecione um ou mais destinat√°rios:</legend>
        <div class="checkbox-grid">
          <label><input type="checkbox" value="AE/ENA"> AE/ENA</label>
          <label><input type="checkbox" value="Diretores/Dire√ß√µes Pedag√≥gicas/Entidades titulares"> Diretores/Dire√ß√µes Pedag√≥gicas/Entidades titulares</label>
          <label><input type="checkbox" value="Docentes"> Docentes</label>
          <label><input type="checkbox" value="Pessoal n√£o docente"> Pessoal n√£o docente</label>
          <label><input type="checkbox" value="Pais e encarregados de educa√ß√£o"> Pais e encarregados de educa√ß√£o</label>
          <label><input type="checkbox" value="Crian√ßas/Alunos"> Crian√ßas/Alunos</label>
          <label><input type="checkbox" value="Estudantes"> Estudantes</label>
          <label><input type="checkbox" value="Institui√ß√µes de Ensino Superior P√∫blicas"> Institui√ß√µes de Ensino Superior P√∫blicas</label>
          <label><input type="checkbox" value="Institui√ß√µes de Ensino Superior Privadas"> Institui√ß√µes de Ensino Superior Privadas</label>
          <label><input type="checkbox" value="Funda√ß√£o para a Ci√™ncia e Tecnologia"> Funda√ß√£o para a Ci√™ncia e Tecnologia</label>
          <label><input type="checkbox" value="Centros de Investiga√ß√£o"> Centros de Investiga√ß√£o</label>
          <label><input type="checkbox" value="Autarquias"> Autarquias</label>
          <label><input type="checkbox" value="Minist√©rio P√∫blico"> Minist√©rio P√∫blico</label>
          <label><input type="checkbox" value="Escolas privadas"> Escolas privadas</label>
          <label><input type="checkbox" value="Outras entidades"> Outras entidades</label>
        </div>
      </fieldset>
      <textarea id="audience" placeholder="O p√∫blico-alvo √©..."
                        aria-describedby="hint-audience"></textarea>
                    <button class="fullscreen-btn" onclick="toggleFS('audience')" aria-label="Expandir Audi√™ncia para ecr√£ inteiro">‚õ∂ Ecr√£ Inteiro</button>
                </div>

                <div class="input-container" id="container-boundaries">
                    <div class="field-header">
                        <label for="boundaries"># LIMITES &amp; ESTILO</label>
                        <button class="hide-toggle-btn" id="hide-btn-boundaries" aria-pressed="false"
                            aria-label="Ocultar Limites &amp; Estilo do prompt"
                            onclick="toggleHide('boundaries', 'Limites &amp; Estilo')">
                            <svg class="icon-eye-open" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                            <svg class="icon-eye-slash" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                        </button>
                    </div>
                    <span id="hint-boundaries" class="hint">Formato, tom, extens√£o ou restri√ß√µes (ex.: tom t√©cnico, m√°x. 2 p√°ginas).</span>
                    <label for="boundaries_style" style="font-weight: 700; color: var(--primary); font-size: 0.9rem; display: block; margin-bottom: 8px;">Estilo:</label>
                    <select id="boundaries_style" style="width: 100%; border: 2px solid var(--border); border-radius: 8px; padding: 10px 12px; font-size: 1rem; font-family: inherit; margin-bottom: 20px; background-color: #fff; transition: all 0.2s; min-height: 44px;" aria-label="Selecionar estilo">
                        <option value="">Selecione um estilo...</option>
                        <option value="Formal">Formal</option>
                        <option value="Informal">Informal</option>
                        <option value="Explicativo">Explicativo</option>
                    </select>

                    <textarea id="boundaries" placeholder="A resposta deve..."
                        aria-describedby="hint-boundaries"></textarea>
                    <button class="fullscreen-btn" onclick="toggleFS('boundaries')" aria-label="Expandir Limites &amp; Estilo para ecr√£ inteiro">‚õ∂ Ecr√£ Inteiro</button>
                </div>

                <hr aria-hidden="true">

                <div class="input-container" id="example-container" style="display:none;">
                    <label for="example"># EXEMPLO</label>
                    <span id="hint-example" class="hint">Um exemplo ilustrativo do formato ou conte√∫do esperado.</span>
                    <textarea id="example" placeholder="Por exemplo..."
                        aria-describedby="hint-example"></textarea>
                    <button class="fullscreen-btn" onclick="toggleFS('example')" aria-label="Expandir Exemplo para ecr√£ inteiro">‚õ∂ Ecr√£ Inteiro</button>
                </div>
                <button id="example-toggle-btn" class="example-toggle-btn" onclick="toggleExample()"
                    aria-expanded="false" aria-controls="example-container">
                    + Adicionar Exemplo <span style="font-weight:400; opacity:0.7;">(opcional)</span>
                </button>
            </div>
        </section>

        <section class="preview-panel" aria-label="Pr√©-visualiza√ß√£o do prompt">
            <div class="panel-header">
                Pr√©-visualiza√ß√£o do Prompt
                <span id="save-status" aria-live="polite" aria-atomic="true">Guardado</span>
            </div>
            <div class="panel-scroll" style="background-color: #fcfcfc;">
                <div id="preview-body" class="preview-body" role="region" aria-label="Prompt gerado" aria-live="polite" aria-atomic="true"></div>
                <div id="prompt-stats" class="prompt-stats" aria-live="polite" aria-atomic="true"></div>
            </div>
            <div class="actions">
                <button class="btn btn-copy" onclick="copyToClipboard()" title="Copiar para a √°rea de transfer√™ncia (Ctrl+Shift+C / ‚åò‚áßC)"
                    aria-label="Copiar prompt para a √°rea de transfer√™ncia">Copiar para a √Årea de Transfer√™ncia</button>
                <button class="btn btn-download" onclick="downloadPrompt()"
                    aria-label="Exportar prompt como ficheiro Markdown">Exportar .md</button>
            </div>
        </section>
    </main>
</div>

<script>
    const fields = ['draft', 'persona', 'context', 'objective', 'audience', 'boundaries', 'example'];

    const HIDEABLE_FIELDS = [
        { id: 'persona',    label: 'Persona/Papel',      heading: '# PERSONA/PAPEL' },
        { id: 'context',    label: 'Contexto',            heading: '# CONTEXTO' },
        { id: 'objective',  label: 'Objetivo',            heading: '# OBJETIVO' },
        { id: 'audience',   label: 'Audi√™ncia',           heading: '# AUDI√äNCIA' },
        { id: 'boundaries', label: 'Limites & Estilo',    heading: '# LIMITES & ESTILO' },
    ];
    const hiddenFields = new Set();

    window.onload = () => {

        fields.forEach(id => {
            const saved = localStorage.getItem('igec_pt_' + id);
            if (saved) document.getElementById(id).value = saved;

            document.getElementById(id).addEventListener('input', () => {
                updatePreview();
                saveLocal(id);
            });
        });

        // Restore & persist persona role dropdown
        const roleSelect = document.getElementById('persona_role');
        const savedRole = localStorage.getItem('igec_pt_persona_role');
        if (savedRole) roleSelect.value = savedRole;

        roleSelect.addEventListener('change', () => {
            localStorage.setItem('igec_pt_persona_role', roleSelect.value);
            updatePreview();
            showSaving();
        });

  // Restore & persist audience checkboxes
  const audBoxWrap = document.getElementById('audience_checks');
  if (audBoxWrap) {
    const saved = localStorage.getItem('igec_pt_audience_checks');
    if (saved) {
      try { const arr = JSON.parse(saved); Array.from(audBoxWrap.querySelectorAll('input[type=\'checkbox\']')).forEach(cb => cb.checked = arr.includes(cb.value)); } catch(e) {}
    }
    audBoxWrap.addEventListener('change', () => {
      const arr = Array.from(audBoxWrap.querySelectorAll('input[type=\'checkbox\']:checked')).map(cb => cb.value);
      localStorage.setItem('igec_pt_audience_checks', JSON.stringify(arr));

      // Automatically add selected recipients to the audience textarea
      const audienceTextarea = document.getElementById('audience');
      if (arr.length > 0) {
        const selectedText = arr.map(item => '- ' + item).join('\n');
        audienceTextarea.value = selectedText;
        localStorage.setItem('igec_pt_audience', selectedText);
      }

      updatePreview();
      showSaving();
    });
  }

  // Restore & persist context addendum toggle
  const addendumToggle = document.getElementById('context_addendum_toggle');
  if (addendumToggle) {
    addendumToggle.checked = localStorage.getItem('igec_pt_context_addendum') === 'true';
    addendumToggle.addEventListener('change', () => {
      localStorage.setItem('igec_pt_context_addendum', addendumToggle.checked);
      updatePreview();
      showSaving();
    });
  }

  // Restore & persist style selection
  const styleSelect = document.getElementById('boundaries_style');
  if (styleSelect) {
    const saved = localStorage.getItem('igec_pt_boundaries_style');
    if (saved) styleSelect.value = saved;

    styleSelect.addEventListener('change', () => {
      localStorage.setItem('igec_pt_boundaries_style', styleSelect.value);
      updatePreview();
      showSaving();
    });
  }

        document.addEventListener('keydown', (e) => {
            if ((e.metaKey || e.ctrlKey) && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                copyToClipboard();
            }
        });

        HIDEABLE_FIELDS.forEach(({ id, label }) => {
            if (localStorage.getItem('igec_pt_' + id + '_hidden') === 'true') {
                hiddenFields.add(id);
                applyHiddenState(id, label, true);
            }
        });

        if (localStorage.getItem('igec_pt_example_visible') === 'true') {
            document.getElementById('example-container').style.display = 'block';
            const btn = document.getElementById('example-toggle-btn');
            btn.textContent = '‚àí Remover Exemplo';
            btn.classList.add('active');
            btn.setAttribute('aria-expanded', 'true');
        }
        updatePreview();
    };

    function applyHiddenState(id, label, isHidden) {
        const container = document.getElementById('container-' + id);
        const btn = document.getElementById('hide-btn-' + id);
        container.classList.toggle('field-hidden', isHidden);
        btn.setAttribute('aria-pressed', isHidden ? 'true' : 'false');
        btn.setAttribute('aria-label', isHidden
            ? 'Mostrar ' + label + ' no prompt'
            : 'Ocultar ' + label + ' do prompt');
    }

    function toggleHide(id, label) {
        const isNowHidden = !hiddenFields.has(id);
        isNowHidden ? hiddenFields.add(id) : hiddenFields.delete(id);
        localStorage.setItem('igec_pt_' + id + '_hidden', isNowHidden ? 'true' : 'false');
        applyHiddenState(id, label, isNowHidden);
        updatePreview();
        announce(isNowHidden ? label + ' ocultado do prompt.' : label + ' inclu√≠do no prompt.');
    }

    function updatePreview() {
  const contextAddendum = `A IGEC exerce a sua atividade no √¢mbito da educa√ß√£o pr√©-escolar e da educa√ß√£o escolar, incluindo as suas modalidades especiais e de educa√ß√£o extraescolar, junto dos estabelecimentos de educa√ß√£o e ensino da rede p√∫blica - incluindo os respetivos agrupamentos e centros de forma√ß√£o de escolas - e das redes privadas, cooperativa e solid√°ria.
A miss√£o, as atribui√ß√µes e a org√¢nica da IGEC encontram-se genericamente estabelecidas no art.¬∫ 11.¬∫ do Decreto-Lei n.¬∫ 125/2011, de 29 de dezembro, e especificamente definidas:
- no Decreto Regulamentar n.¬∫ 15/2012, de 27 de janeiro, que aprova a org√¢nica da IGEC - nos termos previstos no Decreto-Lei n.¬∫ 276/2007, de 31 de julho, na reda√ß√£o atual, que define o regime jur√≠dico da atividade de inspe√ß√£o, auditoria e fiscaliza√ß√£o dos servi√ßos da administra√ß√£o direta e indireta do Estado;
- na Portaria n.¬∫ 145/2012, de 16 de maio, que fixa a estrutura org√¢nica, com as altera√ß√µes introduzidas pela Portaria n.¬∫ 256/2012, de 27 de agosto, e pela Portaria n.¬∫ 230/2013, de 18 de julho;
- e no Despacho n.¬∫ 10433/2013, no Despacho n.¬∫ 10036/2020 e Despacho n.¬∫ 7633/2024, que definem as unidades org√¢nicas flex√≠veis e as equipas multidisciplinares, bem como as √°reas territoriais de inspe√ß√£o.`;
  const segments = [];

  HIDEABLE_FIELDS
    .filter(({ id }) => !hiddenFields.has(id))
    .forEach(({ id, heading }) => {
      let val = "";
      if (id === 'persona') {
        const roleEl = document.getElementById('persona_role');
        const role = roleEl ? roleEl.value : '';
        const txtEl = document.getElementById('persona');
        const txtVal = txtEl ? txtEl.value.trim() : '';
        if (role && txtVal) { val = 'A sua fun√ß√£o na IGEC (Inspe√ß√£o-Geral da Educa√ß√£o e Ci√™ncia): ' + role + '\n\n' + txtVal; }
        else if (role) { val = 'A sua fun√ß√£o na IGEC (Inspe√ß√£o-Geral da Educa√ß√£o e Ci√™ncia): ' + role; }
        else if (txtVal) { val = txtVal; }
        else { val = '(' + heading.slice(2) + ' n√£o definido)'; }
      } else if (id === 'context') {
        const el = document.getElementById('context');
        const base = el ? el.value.trim() : '';
        const addendumChecked = document.getElementById('context_addendum_toggle')?.checked;
        const parts = [];
        if (addendumChecked) parts.push(contextAddendum);
        if (base) parts.push(base);
        val = parts.join('\n\n') || '(' + heading.slice(2) + ' n√£o definido)';
      } else if (id === 'audience') {
        const boxWrap = document.getElementById('audience_checks');
        const chosen = boxWrap ? Array.from(boxWrap.querySelectorAll('input[type\=\"checkbox\\"]:checked')).map(o => o.value) : [];
        const base = (document.getElementById('audience') || {}).value || '';
        if (chosen.length && base) { val = 'Sele√ß√£o: ' + chosen.join('; ') + '\n\n' + base; }
        else if (chosen.length) { val = 'Sele√ß√£o: ' + chosen.join('; '); }
        else if (base) { val = base; }
        else { val = '(' + heading.slice(2) + ' n√£o definido)'; }
      } else if (id === 'boundaries') {
        const styleSelect = document.getElementById('boundaries_style');
        const selectedStyle = styleSelect ? styleSelect.value : '';
        const base = (document.getElementById('boundaries') || {}).value || '';
        const parts = [];
        if (selectedStyle) parts.push('O estilo deve ser: ' + selectedStyle);
        if (base) parts.push(base);
        val = parts.length ? parts.join('\n\n') : '(' + heading.slice(2) + ' n√£o definido)';
      } else {
        const el = document.getElementById(id);
        const base = el ? el.value : '';
        val = base || '(' + heading.slice(2) + ' n√£o definido)';
      }
      segments.push(heading + '\n' + val);
    });

  const exampleVisible = document.getElementById('example-container').style.display !== 'none';
  if (exampleVisible) {
    const eEl = document.getElementById('example');
    const e = eEl ? (eEl.value || '(EXEMPLO n√£o definido)') : '(EXEMPLO n√£o definido)';
    segments.push('# EXEMPLO\n' + e);
  }

  const template = segments.join('\n\n');
  const highlighted = template.replace(/(# [A-Z√Ä-√ö &\/]+)/g, '<span class="tag-h1">$1<\/span>');
  document.getElementById('preview-body').innerHTML = highlighted;

  const words = template.trim().split(/\s+/).filter(Boolean).length;
  const chars = template.length;
  document.getElementById('prompt-stats').textContent = `${words} palavras ¬∑ ${chars.toLocaleString()} caracteres`;
}


    function announce(msg) {
        const el = document.getElementById('a11y-announce');
        el.textContent = '';
        // Small delay so screen readers re-announce even identical text
        setTimeout(() => { el.textContent = msg; }, 50);
    }

    function showSaving() {
        const status = document.getElementById('save-status');
        const root = document.documentElement;
        status.innerText = 'A guardar...';
        status.style.color = getComputedStyle(root).getPropertyValue('--saving').trim();
        clearTimeout(window.saveTimer);
        window.saveTimer = setTimeout(() => {
            status.innerText = 'Guardado no browser';
            status.style.color = getComputedStyle(root).getPropertyValue('--success').trim();
        }, 1000);
    }

    function saveLocal(id) {
        localStorage.setItem('igec_pt_' + id, document.getElementById(id).value);
        showSaving();
    }

    function toggleFS(id) {
        const el = document.getElementById(id);
        el.classList.toggle('fullscreen-active');
        if (el.classList.contains('fullscreen-active')) {
            el.focus();
            // Trap focus: Escape exits fullscreen
            el.onkeydown = (e) => { if (e.key === "Escape") toggleFS(id); };

            const exitBtn = document.createElement('button');
            exitBtn.className = 'fs-exit-btn';
            exitBtn.id = 'fs-exit-btn';
            exitBtn.innerHTML = '&#x2715; Voltar √† Vista Normal';
            exitBtn.setAttribute('aria-label', 'Sair do ecr√£ inteiro e voltar √† vista normal');
            exitBtn.onclick = () => toggleFS(id);
            // Keep Tab focus inside fullscreen (textarea ‚Üî exit button)
            exitBtn.onkeydown = (e) => {
                if (e.key === 'Tab') { e.preventDefault(); el.focus(); }
                if (e.key === 'Escape') toggleFS(id);
            };
            el.onkeydown = (e) => {
                if (e.key === 'Escape') toggleFS(id);
                if (e.key === 'Tab' && !e.shiftKey) { e.preventDefault(); exitBtn.focus(); }
            };
            document.body.appendChild(exitBtn);
            announce('Modo ecr√£ inteiro. Prima Escape ou Tab para aceder ao bot√£o de sa√≠da.');
        } else {
            const exitBtn = document.getElementById('fs-exit-btn');
            if (exitBtn) exitBtn.remove();
            el.onkeydown = null;
            announce('Voltou √† vista normal.');
        }
    }

    function toggleExample() {
        const container = document.getElementById('example-container');
        const btn = document.getElementById('example-toggle-btn');
        const isVisible = container.style.display !== 'none';
        if (isVisible) {
            container.style.display = 'none';
            btn.innerHTML = '+ Adicionar Exemplo <span style="font-weight:400; opacity:0.7;">(opcional)</span>';
            btn.classList.remove('active');
            btn.setAttribute('aria-expanded', 'false');
            localStorage.setItem('igec_pt_example_visible', 'false');
            announce('Sec√ß√£o de exemplo ocultada.');
        } else {
            container.style.display = 'block';
            btn.textContent = '‚àí Remover Exemplo';
            btn.classList.add('active');
            btn.setAttribute('aria-expanded', 'true');
            localStorage.setItem('igec_pt_example_visible', 'true');
            document.getElementById('example').focus();
            announce('Sec√ß√£o de exemplo mostrada.');
        }
        updatePreview();
    }

    function copyToClipboard() {
        const text = document.getElementById('preview-body').innerText;
        navigator.clipboard.writeText(text).then(() => {
            const btn = document.querySelector('.btn-copy');
            const originalText = btn.innerText;
            btn.innerText = "‚úì Copiado!";
            announce('Prompt copiado para a √°rea de transfer√™ncia.');
            setTimeout(() => btn.innerText = originalText, 2000);
        });
    }

    function downloadPrompt() {
        const text = document.getElementById('preview-body').innerText;
        const blob = new Blob([text], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `prompt_${new Date().toISOString().split('T')[0]}.md`;
        a.click();
    }

    function exportSchema() {
        const date = new Date().toISOString().split('T')[0];
        const lines = [
            `# Esquema da Interface ‚Äî Construtor de prompts para IGEC v1.0`,
            `_Utilize este ficheiro para sugerir melhorias √† interface (ex.: menus pendentes, caixas de sele√ß√£o, novos campos)._`,
            `_Data de exporta√ß√£o: ${date}_`,
            ``
        ];

        // Helper to read text content of an element, stripping extra whitespace
        const text = (el) => el ? el.textContent.trim() : '';

        // Draft field (not hideable, no hide state)
        const draftEl = document.getElementById('draft');
        lines.push(`---`, ``);
        lines.push(`## Campo: ${text(document.querySelector('label[for="draft"]'))}`);
        lines.push(`- **ID:** \`draft\``);
        lines.push(`- **Tipo atual:** \`textarea\``);
        lines.push(`- **Etiqueta:** ${text(document.querySelector('label[for="draft"]'))}`);
        lines.push(`- **Dica:** ${text(document.getElementById('hint-draft'))}`);
        lines.push(`- **Placeholder:** ${draftEl.placeholder}`);
        lines.push(`- **Valor atual:** ${draftEl.value.trim() || '*(vazio)*'}`);
        lines.push(`- **Sugest√µes de melhoria:**`);
        lines.push(``);

        // Hideable fields
        HIDEABLE_FIELDS.forEach(({ id, label }) => {
            const el = document.getElementById(id);
            const isHidden = hiddenFields.has(id);
            const labelEl = document.querySelector(`label[for="${id}"]`);
            const hintEl = document.getElementById(`hint-${id}`);
            lines.push(`---`, ``);
            lines.push(`## Campo: ${label}`);
            lines.push(`- **ID:** \`${id}\``);
            lines.push(`- **Tipo atual:** \`textarea\``);
            lines.push(`- **Etiqueta:** ${text(labelEl)}`);
            lines.push(`- **Dica:** ${text(hintEl)}`);
            lines.push(`- **Placeholder:** ${el.placeholder}`);
            lines.push(`- **Estado:** ${isHidden ? 'oculto do prompt' : 'vis√≠vel no prompt'}`);
            lines.push(`- **Valor atual:** ${el.value.trim() || '*(vazio)*'}`);
            lines.push(`- **Sugest√µes de melhoria:**`);
            lines.push(``);
        });

        // Example field (optional, may be hidden)
        const exampleVisible = document.getElementById('example-container').style.display !== 'none';
        const exampleEl = document.getElementById('example');
        lines.push(`---`, ``);
        lines.push(`## Campo: EXEMPLO *(opcional)*`);
        lines.push(`- **ID:** \`example\``);
        lines.push(`- **Tipo atual:** \`textarea\``);
        lines.push(`- **Etiqueta:** # EXEMPLO`);
        lines.push(`- **Dica:** ${text(document.getElementById('hint-example'))}`);
        lines.push(`- **Placeholder:** ${exampleEl.placeholder}`);
        lines.push(`- **Estado:** ${exampleVisible ? 'vis√≠vel' : 'oculto (sec√ß√£o n√£o expandida)'}`);
        lines.push(`- **Valor atual:** ${exampleEl.value.trim() || '*(vazio)*'}`);
        lines.push(`- **Sugest√µes de melhoria:**`);
        lines.push(``);

        lines.push(`---`);
        lines.push(`_Envie este ficheiro preenchido ao respons√°vel pelo desenvolvimento da ferramenta._`);

        const blob = new Blob([lines.join('\n')], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `esquema_interface_${date}.md`;
        a.click();
        URL.revokeObjectURL(url);
        announce('Esquema da interface exportado.');
    }

    function resetForm() {
        if(confirm("Tem a certeza de que pretende apagar todos os dados? Esta a√ß√£o n√£o pode ser desfeita.")) {
            fields.forEach(id => {
                document.getElementById(id).value = '';
                localStorage.removeItem('igec_pt_' + id);
            });
            HIDEABLE_FIELDS.forEach(({ id, label }) => {
                hiddenFields.delete(id);
                localStorage.removeItem('igec_pt_' + id + '_hidden');
                applyHiddenState(id, label, false);
            });
            document.getElementById('example-container').style.display = 'none';
            const btn = document.getElementById('example-toggle-btn');
            btn.innerHTML = '+ Adicionar Exemplo <span style="font-weight:400; opacity:0.7;">(opcional)</span>';
            btn.classList.remove('active');
            localStorage.removeItem('igec_pt_example_visible');
            const roleSelect = document.getElementById('persona_role');
            roleSelect.value = '';
            localStorage.removeItem('igec_pt_persona_role');
            const styleSelect = document.getElementById('boundaries_style');
            styleSelect.value = '';
            localStorage.removeItem('igec_pt_boundaries_style');
            const addendumToggle = document.getElementById('context_addendum_toggle');
            if (addendumToggle) addendumToggle.checked = false;
            localStorage.removeItem('igec_pt_context_addendum');
            updatePreview();
        }
    }

    function backupCacheJSON() {
        const backup = {};

        // Backup all text fields
        fields.forEach(id => {
            backup['igec_pt_' + id] = localStorage.getItem('igec_pt_' + id) || '';
        });

        // Backup persona role
        backup['igec_pt_persona_role'] = localStorage.getItem('igec_pt_persona_role') || '';

        // Backup audience checkboxes
        backup['igec_pt_audience_checks'] = localStorage.getItem('igec_pt_audience_checks') || '';

        // Backup style selection
        backup['igec_pt_boundaries_style'] = localStorage.getItem('igec_pt_boundaries_style') || '';

        // Backup hidden field states
        HIDEABLE_FIELDS.forEach(({ id }) => {
            backup['igec_pt_' + id + '_hidden'] = localStorage.getItem('igec_pt_' + id + '_hidden') || 'false';
        });

        // Backup example visibility
        backup['igec_pt_example_visible'] = localStorage.getItem('igec_pt_example_visible') || 'false';

        // Create a timestamped backup file
        const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
        const backupData = JSON.stringify(backup, null, 2);
        const blob = new Blob([backupData], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `prompt_backup_${timestamp}.json`;
        a.click();
        URL.revokeObjectURL(url);

        announce('C√≥pia de seguran√ßa JSON criada com sucesso.');
    }

    function restoreCacheJSON() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.json';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const backup = JSON.parse(event.target.result);

                    // Restore all data
                    Object.keys(backup).forEach(key => {
                        if (backup[key]) {
                            localStorage.setItem(key, backup[key]);
                        } else {
                            localStorage.removeItem(key);
                        }
                    });

                    // Reload the page to apply restored data
                    window.location.reload();
                } catch (error) {
                    announce('Erro ao restaurar a c√≥pia de seguran√ßa. Ficheiro inv√°lido.');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }

    function backupCacheMD() {
        const timestamp = new Date().toISOString().split('T')[0];
        const time = new Date().toLocaleTimeString('pt-PT');
        const lines = [
            `# Prompt Backup ‚Äî ${timestamp} ${time}`,
            ``
        ];

        // Draft
        const draft = document.getElementById('draft').value || '';
        lines.push(`## Pedido Inicial (para refer√™ncia)`);
        lines.push(draft || '*(vazio)*');
        lines.push(``);

        // Persona
        const personaRole = document.getElementById('persona_role').value || '';
        const persona = document.getElementById('persona').value || '';
        lines.push(`## Persona/Papel`);
        if (personaRole) lines.push(`**Cargo:** ${personaRole}`);
        lines.push(persona || '*(vazio)*');
        lines.push(``);

        // Context
        const context = document.getElementById('context').value || '';
        lines.push(`## Contexto`);
        lines.push(context || '*(vazio)*');
        lines.push(``);

        // Objective
        const objective = document.getElementById('objective').value || '';
        lines.push(`## Objetivo`);
        lines.push(objective || '*(vazio)*');
        lines.push(``);

        // Audience
        const audBoxWrap = document.getElementById('audience_checks');
        const chosen = audBoxWrap ? Array.from(audBoxWrap.querySelectorAll('input[type="checkbox"]:checked')).map(o => o.value) : [];
        const audience = document.getElementById('audience').value || '';
        lines.push(`## Audi√™ncia`);
        if (chosen.length > 0) {
            lines.push(`**Sele√ß√£o:** ${chosen.join('; ')}`);
            if (audience) lines.push(``);
        }
        lines.push(audience || '*(vazio)*');
        lines.push(``);

        // Boundaries & Style
        const styleSelect = document.getElementById('boundaries_style');
        const style = styleSelect ? styleSelect.value : '';
        const boundaries = document.getElementById('boundaries').value || '';
        lines.push(`## Limites & Estilo`);
        if (style) lines.push(`**Estilo:** ${style}`);
        lines.push(boundaries || '*(vazio)*');
        lines.push(``);

        // Example (if visible)
        const exampleVisible = document.getElementById('example-container').style.display !== 'none';
        if (exampleVisible) {
            const example = document.getElementById('example').value || '';
            lines.push(`## Exemplo`);
            lines.push(example || '*(vazio)*');
            lines.push(``);
        }

        const mdContent = lines.join('\n');
        const blob = new Blob([mdContent], { type: 'text/markdown' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `prompt_backup_${timestamp.replace(/-/g, '')}.md`;
        a.click();
        URL.revokeObjectURL(url);

        announce('C√≥pia de seguran√ßa Markdown criada com sucesso.');
    }

    function restoreCacheMD() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = '.md';
        input.onchange = (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const mdContent = event.target.result;
                    const sections = {};
                    let currentSection = null;
                    let currentContent = [];

                    const lines = mdContent.split('\n');
                    lines.forEach((line) => {
                        if (line.startsWith('## ')) {
                            if (currentSection) {
                                sections[currentSection] = currentContent.join('\n').trim();
                            }
                            currentSection = line.replace('## ', '').trim();
                            currentContent = [];
                        } else if (currentSection) {
                            currentContent.push(line);
                        }
                    });
                    if (currentSection) {
                        sections[currentSection] = currentContent.join('\n').trim();
                    }

                    // Restore data
                    document.getElementById('draft').value = sections['Pedido Inicial (para refer√™ncia)'] || '';

                    const personaSection = (sections['Persona/Papel'] || '').split('\n');
                    const cargoLine = personaSection.find(line => line.startsWith('**Cargo:**'));
                    if (cargoLine) {
                        const cargo = cargoLine.replace('**Cargo:** ', '').trim();
                        document.getElementById('persona_role').value = cargo;
                    }
                    const personaText = personaSection.filter(line => !line.startsWith('**Cargo:**')).join('\n').trim();
                    document.getElementById('persona').value = personaText === '*(vazio)*' ? '' : personaText;

                    document.getElementById('context').value = (sections['Contexto'] || '').replace('*(vazio)*', '').trim();
                    document.getElementById('objective').value = (sections['Objetivo'] || '').replace('*(vazio)*', '').trim();
                    document.getElementById('boundaries').value = (sections['Limites & Estilo'] || '').replace(/\*\*Estilo:\*\*.*?\n?/g, '').replace('*(vazio)*', '').trim();

                    const styleSection = sections['Limites & Estilo'] || '';
                    const styleLine = styleSection.match(/\*\*Estilo:\*\* (.+)/);
                    if (styleLine) {
                        document.getElementById('boundaries_style').value = styleLine[1].trim();
                    }

                    const audienceSection = (sections['Audi√™ncia'] || '').split('\n');
                    const selectionLine = audienceSection.find(line => line.startsWith('**Sele√ß√£o:**'));
                    if (selectionLine) {
                        const selected = selectionLine.replace('**Sele√ß√£o:** ', '').split('; ');
                        const checkboxes = document.getElementById('audience_checks').querySelectorAll('input[type="checkbox"]');
                        checkboxes.forEach(cb => {
                            cb.checked = selected.includes(cb.value);
                        });
                    }
                    const audienceText = audienceSection.filter(line => !line.startsWith('**Sele√ß√£o:**')).join('\n').trim();
                    document.getElementById('audience').value = audienceText === '*(vazio)*' ? '' : audienceText;

                    if (sections['Exemplo']) {
                        document.getElementById('example-container').style.display = 'block';
                        const btn = document.getElementById('example-toggle-btn');
                        btn.textContent = '‚àí Remover Exemplo';
                        btn.classList.add('active');
                        btn.setAttribute('aria-expanded', 'true');
                        document.getElementById('example').value = sections['Exemplo'].replace('*(vazio)*', '').trim();
                    }

                    // Trigger updates
                    updatePreview();
                    fields.forEach(id => saveLocal(id));

                    announce('Importa√ß√£o Markdown conclu√≠da com sucesso.');
                } catch (error) {
                    announce('Erro ao importar o ficheiro Markdown. Ficheiro inv√°lido.');
                }
            };
            reader.readAsText(file);
        };
        input.click();
    }
</script>

</body>
</html>
